name: "Agent Intake Investigation"
on:
  issues:
    types: [assigned]
  workflow_dispatch:

jobs:
  investigate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Create output folders
        run: |
          mkdir -p atomic distillations analyses process_memory backlog catalogue

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Retrieve issue form outputs
        id: get-outputs
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const outputs = github.context.payload.issue.body.match(/---\n(.+?)\n---/s);
            let result = {};
            if (outputs && outputs[1]) {
              for(const line of outputs[1].split('\n')) {
                if(line.includes(':')) {
                  const [key, ...rest] = line.split(':');
                  result[key.trim()] = rest.join(':').trim();
                }
              }
            }
            return result;

      - name: Generate investigation artifacts
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          AGENT_TARGET: ${{ steps.get-outputs.outputs.agent_target }}
          AGENT_DEPTH: ${{ steps.get-outputs.outputs.agent_depth }}
          AGENT_TOOLS: ${{ steps.get-outputs.outputs.agent_tools }}
          AGENT_INTENT: ${{ steps.get-outputs.outputs.agent_intent }}
          AGENT_CLUES: ${{ steps.get-outputs.outputs.agent_clues }}
        run: |
          python .github/scripts/generate_artifacts.py

      - name: Commit and push new artifacts
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add atomic/ distillations/ analyses/ process_memory/ backlog/ catalogue/
          git commit -m "Add investigation artifacts via Copilot for issue #${{ github.event.issue.number }}"
          git push
